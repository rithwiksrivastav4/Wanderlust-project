name: Deploy to EKS (Docker Hub images)

on:
  push:
    branches: ["main"]
  workflow_dispatch:

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}
  CLUSTER_NAME: ${{ secrets.EKS_CLUSTER_NAME }}
  K8S_NAMESPACE: "default"

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/$(curl -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/

      - name: Update kubeconfig for EKS
        run: aws eks update-kubeconfig --name ${{ env.CLUSTER_NAME }} --region ${{ env.AWS_REGION }}

      - name: Create Docker Hub imagePullSecret (optional)
        run: |
          if [ -n "${{ secrets.DOCKERHUB_USERNAME }}" ] && [ -n "${{ secrets.DOCKERHUB_TOKEN }}" ]; then
            echo "Creating dockerhub-creds secret..."
            kubectl create secret docker-registry dockerhub-creds \
              --docker-server=https://index.docker.io/v1/ \
              --docker-username="${{ secrets.DOCKERHUB_USERNAME }}" \
              --docker-password="${{ secrets.DOCKERHUB_TOKEN }}" \
              --docker-email="${{ secrets.DOCKERHUB_EMAIL }}" \
              -n ${{ env.K8S_NAMESPACE }} || echo "secret exists, skipping"
          else
            echo "Docker Hub secrets not set â€” skipping imagePullSecret creation"
          fi

      - name: Apply kubernetes manifests (as-is)
        run: kubectl apply -f kubernetes/ -n ${{ env.K8S_NAMESPACE }}

      - name: Verify rollout (frontend)
        run: |
          kubectl -n ${{ env.K8S_NAMESPACE }} rollout status deployment/wanderlust-frontend --timeout=120s || kubectl -n ${{ env.K8S_NAMESPACE }} get pods -o wide

      - name: Verify rollout (backend)
        run: |
          kubectl -n ${{ env.K8S_NAMESPACE }} rollout status deployment/wanderlust-backend --timeout=120s || kubectl -n ${{ env.K8S_NAMESPACE }} get pods -o wide
