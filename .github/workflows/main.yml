name: Deploy to EKS (Docker Hub images)

on:
  push:
    branches: ["main"]
  workflow_dispatch:

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}
  CLUSTER_NAME: ${{ secrets.EKS_CLUSTER_NAME }}
  K8S_NAMESPACE: "default"

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # -----------------------------
      # CHECKOUT REPO
      # -----------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -----------------------------
      # CONFIGURE AWS
      # -----------------------------
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # -----------------------------
      # INSTALL KUBECTL (WORKS 100%)
      # -----------------------------
      - name: Install kubectl
        run: |
          sudo apt-get update -y
          sudo apt-get install -y kubectl

      # -----------------------------
      # AUTHENTICATE WITH EKS
      # -----------------------------
      - name: Update kubeconfig for EKS
        run: |
          aws eks update-kubeconfig \
            --name ${{ env.CLUSTER_NAME }} \
            --region ${{ env.AWS_REGION }}

      # -----------------------------
      # OPTIONAL: CREATE DOCKER HUB SECRET (PRIVATE REPOS ONLY)
      # -----------------------------
      - name: Create Docker Hub imagePullSecret (optional)
        run: |
          if [ -n "${{ secrets.DOCKERHUB_USERNAME }}" ] && [ -n "${{ secrets.DOCKERHUB_TOKEN }}" ]; then
            echo "Creating dockerhub-creds secret..."
            kubectl create secret docker-registry dockerhub-creds \
              --docker-server=https://index.docker.io/v1/ \
              --docker-username="${{ secrets.DOCKERHUB_USERNAME }}" \
              --docker-password="${{ secrets.DOCKERHUB_TOKEN }}" \
              --docker-email="${{ secrets.DOCKERHUB_EMAIL }}" \
              -n ${{ env.K8S_NAMESPACE }} || echo "Secret already exists"
          else
            echo "DockerHub credentials not provided â€“ skipping."
          fi

      # -----------------------------
      # APPLY KUBERNETES MANIFESTS
      # -----------------------------
      - name: Apply kubernetes manifests
        run: |
          kubectl apply -f kubernetes/ -n ${{ env.K8S_NAMESPACE }}

      # -----------------------------
      # VERIFY FRONTEND ROLLOUT
      # -----------------------------
      - name: Verify frontend rollout
        run: |
          kubectl -n ${{ env.K8S_NAMESPACE }} rollout status deployment/wanderlust-frontend --timeout=120s || true
          kubectl -n ${{ env.K8S_NAMESPACE }} get pods -o wide

      # -----------------------------
      # VERIFY BACKEND ROLLOUT
      # -----------------------------
      - name: Verify backend rollout
        run: |
          kubectl -n ${{ env.K8S_NAMESPACE }} rollout status deployment/wanderlust-backend --timeout=120s || true
          kubectl -n ${{ env.K8S_NAMESPACE }} get pods -o wide
